<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GraphSense IA</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #0c0e12;
      color: #e6f1ee;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background: #111417;
      border-bottom: 1px solid #1e2428;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
    }

    header h1 {
      color: #31d17b;
      font-size: 20px;
    }

    button {
      background: #1b2421;
      color: #baffdf;
      border: 1px solid #1f6a47;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: bold;
    }

    main {
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 20px;
    }

    .card {
      background: #13171c;
      border: 1px solid #1b2127;
      border-radius: 10px;
      padding: 15px;
    }

    .title {
      color: #cfece0;
      font-weight: bold;
      margin-bottom: 10px;
    }

    canvas {
      background: #0e1014;
      border-radius: 8px;
      width: 100%;
      height: 400px;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>üöÄ GraphSense IA</h1>
    <div>
      <button onclick="toggleType()">Alternar Linha ‚Üî Candle</button>
      <button onclick="reloadData()">Atualizar</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="title">üìà Gr√°fico</div>
      <canvas id="chartMain"></canvas>
    </section>

    <aside class="card">
      <div class="title">‚öôÔ∏è Op√ß√µes</div>
      <label><input type="checkbox" id="sma20" checked> SMA 20</label><br>
      <label><input type="checkbox" id="sma50" checked> SMA 50</label>
    </aside>

    <section class="card" style="grid-column: 1 / -1;">
      <div class="title">RSI (14)</div>
      <canvas id="chartRSI"></canvas>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <div class="title">MACD (12,26,9)</div>
      <canvas id="chartMACD"></canvas>
    </section>
  </main>

  <script>
    let chartMain, chartRSI, chartMACD;
    let modo = "candle";

    function destroyCharts() {
      chartMain?.destroy();
      chartRSI?.destroy();
      chartMACD?.destroy();
    }

    async function reloadData() {
      const resp = await fetch("/ohlc?n=150");
      const j = await resp.json();
      if (!j.ok) return;
      renderAll(j.data);
    }

    function toggleType() {
      modo = modo === "candle" ? "line" : "candle";
      reloadData();
    }

    // ----- Indicadores -----
    function SMA(data, period) {
      let sma = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period) sma.push(null);
        else {
          const avg = data.slice(i - period, i).reduce((a, b) => a + b, 0) / period;
          sma.push(avg);
        }
      }
      return sma;
    }

    function EMA(data, period) {
      const k = 2 / (period + 1);
      let ema = [data[0]];
      for (let i = 1; i < data.length; i++) {
        ema.push(data[i] * k + ema[i - 1] * (1 - k));
      }
      return ema;
    }

    function RSI(data, period = 14) {
      let rsi = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period) rsi.push(null);
        else {
          let gains = 0, losses = 0;
          for (let j = i - period; j < i; j++) {
            const diff = data[j + 1] - data[j];
            if (diff >= 0) gains += diff; else losses -= diff;
          }
          const rs = gains / (losses || 1);
          rsi.push(100 - 100 / (1 + rs));
        }
      }
      return rsi;
    }

    function MACD(data, fast = 12, slow = 26, signal = 9) {
      const fastEma = EMA(data, fast);
      const slowEma = EMA(data, slow);
      const macd = data.map((_, i) => (fastEma[i] || 0) - (slowEma[i] || 0));
      const signalLine = EMA(macd, signal);
      return { macd, signal: signalLine };
    }

    // ----- Gr√°fico principal -----
    function renderAll(data) {
      destroyCharts();
      const ctx = document.getElementById("chartMain").getContext("2d");
      const labels = data.map(d => d.x);
      const closes = data.map(d => d.c);
      const sma20 = SMA(closes, 20);
      const sma50 = SMA(closes, 50);

      let datasets = [];

      if (modo === "candle") {
        // desenha candles manualmente
        const candleData = {
          labels,
          datasets: [{
            label: "Pre√ßo",
            data: closes,
            borderColor: "#00E676",
            pointRadius: 0,
            borderWidth: 2,
            tension: 0.1
          }]
        };

        // desenha como barras coloridas para simular candles
        const bars = data.map(d => ({
          x: d.x,
          y: Math.max(d.o, d.c),
          h: Math.abs(d.o - d.c),
          color: d.c > d.o ? "#00E676" : "#FF1744"
        }));

        const barCtx = document.getElementById("chartMain").getContext("2d");
        chartMain = new Chart(barCtx, {
          type: "bar",
          data: {
            labels,
            datasets: [{
              label: "Candle",
              data: bars.map(b => b.y),
              backgroundColor: bars.map(b => b.color),
              borderWidth: 0
            }]
          },
          options: {
            plugins: { legend: { labels: { color: "#9ad0b3" } } },
            scales: {
              x: { ticks: { color: "#aaa" }, grid: { color: "#1b1f24" } },
              y: { ticks: { color: "#aaa" }, grid: { color: "#1b1f24" } }
            }
          }
        });

      } else {
        // gr√°fico linha
        const lineCtx = document.getElementById("chartMain").getContext("2d");
        datasets.push({
          label: "Pre√ßo",
          data: closes,
          borderColor: "#31d17b",
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25
        });
        if (document.getElementById("sma20").checked) {
          datasets.push({ label: "SMA20", data: sma20, borderColor: "#FFEB3B", borderWidth: 1.5, pointRadius: 0 });
        }
        if (document.getElementById("sma50").checked) {
          datasets.push({ label: "SMA50", data: sma50, borderColor: "#03A9F4", borderWidth: 1.5, pointRadius: 0 });
        }
        chartMain = new Chart(lineCtx, {
          type: "line",
          data: { labels, datasets },
          options: {
            plugins: { legend: { labels: { color: "#9ad0b3" } } },
            scales: {
              x: { ticks: { color: "#aaa" }, grid: { color: "#1b1f24" } },
              y: { ticks: { color: "#aaa" }, grid: { color: "#1b1f24" } }
            }
          }
        });
      }

      // RSI
      const ctxRSI = document.getElementById("chartRSI").getContext("2d");
      const rsi = RSI(closes, 14);
      chartRSI = new Chart(ctxRSI, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "RSI (14)",
            data: rsi,
            borderColor: "#FFEB3B",
            borderWidth: 1.5,
            pointRadius: 0
          }]
        },
        options: {
          plugins: { legend: { labels: { color: "#e7dfa5" } } },
          scales: {
            x: { ticks: { color: "#9aa6a0" } },
            y: { ticks: { color: "#9aa6a0" }, suggestedMin: 0, suggestedMax: 100 }
          }
        }
      });

      // MACD
      const ctxMACD = document.getElementById("chartMACD").getContext("2d");
      const macdObj = MACD(closes);
      chartMACD = new Chart(ctxMACD, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "MACD", data: macdObj.macd, borderColor: "#00E5FF", borderWidth: 1.3, pointRadius: 0 },
            { label: "Signal", data: macdObj.signal, borderColor: "#FF4081", borderWidth: 1.3, pointRadius: 0 }
          ]
        },
        options: {
          plugins: { legend: { labels: { color: "#bfe7db" } } },
          scales: {
            x: { ticks: { color: "#aaa" }, grid: { color: "#1b1f24" } },
            y: { ticks: { color: "#aaa" }, grid: { color: "#1b1f24" } }
          }
        }
      });
    }

    reloadData();
  </script>
</body>
</html>
