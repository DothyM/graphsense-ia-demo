<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>GraphSense IA ‚Ä¢ Plataforma</title>

  <!-- Chart.js + financial (candlestick) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0"></script>

  <style>
    :root {
      --bg:#0b0c0e; --panel:#121417; --text:#e6ffe6; --muted:#9fb3a6;
      --green:#00ff99; --green2:#00d47d; --red:#ff4d4d; --accent:#62ffa6;
      --shadow: 0 0 24px rgba(0,255,153,.15);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #1b1d22;background:#0d0f12;position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:22px;color:var(--accent)}
    .brand span{opacity:.85}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    select,button,.pill{background:var(--panel);color:var(--text);border:1px solid #1b1f25;border-radius:10px;padding:10px 12px}
    button{cursor:pointer;box-shadow:var(--shadow);font-weight:700}
    button.green{background:linear-gradient(180deg,var(--green),var(--green2));color:#001a11;border:none}
    button.red{background:linear-gradient(180deg,#ff8080,var(--red));color:#2a0000;border:none}
    .pill{font-weight:700}
    main{padding:22px;display:grid;grid-template-columns:1fr 320px;gap:18px}
    @media (max-width:1100px){main{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid #1a2026;border-radius:14px;padding:14px;box-shadow:var(--shadow)}
    .stack{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-weight:800;color:#d6ffe6}
    .muted{color:var(--muted);font-size:13px}
    .balance{display:flex;gap:12px;align-items:center}
    .kpi{background:#0f1317;border:1px solid #1b222b;border-radius:10px;padding:10px 12px}
    .signal{padding:10px;border-radius:10px;background:#0f1614;border:1px dashed #284a3b}
    canvas{background:#0f1215;border-radius:10px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      üöÄ <span>GraphSense IA ‚Ä¢ Plataforma</span>
    </div>

    <div class="controls">
      <div class="pill" id="modePill">üß™ Demo</div>
      <div class="balance">
        <div class="kpi">Saldo: <b id="saldo">R$ 10.000,00</b></div>
        <div class="kpi">P/L: <b id="pl-dia">R$ 0,00</b></div>
      </div>
      <select id="symbol">
        <option value="SIM-EURUSD">EURUSD</option>
        <option value="SIM-BTCUSD">BTCUSD</option>
        <option value="SIM-AAPL">AAPL</option>
      </select>
      <select id="tf">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
      </select>
      <button onclick="reloadData()">Atualizar</button>
      <button onclick="toggleType()">Alternar: Linha ‚Üî Candle</button>
      <label class="muted"><input type="checkbox" id="sma20Ck" checked> SMA 20</label>
      <label class="muted"><input type="checkbox" id="sma50Ck" checked> SMA 50</label>
    </div>
  </header>

  <main>
    <section class="card stack">
      <div class="row" style="justify-content:space-between">
        <div class="title">üìà Gr√°fico</div>
        <div class="row">
          <button class="green" onclick="executar('buy')">Comprar</button>
          <button class="red" onclick="executar('sell')">Vender</button>
        </div>
      </div>
      <canvas id="chartMain" height="380"></canvas>
      <div class="row">
        <div class="card stack" style="flex:1">
          <div class="title">RSI (14)</div>
          <canvas id="chartRSI" height="120"></canvas>
        </div>
        <div class="card stack" style="flex:1">
          <div class="title">MACD (12,26,9)</div>
          <canvas id="chartMACD" height="120"></canvas>
        </div>
      </div>
    </section>

    <aside class="card stack">
      <div class="title">ü§ñ Sinal da IA</div>
      <div class="signal">
        <div class="row" style="justify-content:space-between">
          <div>√öltimo sinal: <b id="last-signal">‚Äî</b></div>
          <div>Confian√ßa: <b id="last-conf">‚Äî</b></div>
        </div>
        <div class="muted" id="reasons">Motivos‚Ä¶</div>
      </div>

      <div class="stack">
        <div class="title">‚öôÔ∏è Prefer√™ncias</div>
        <label class="muted"><input type="checkbox" id="fractalCk"> Marcar fractais</label>
        <label class="muted"><input type="checkbox" id="autoIA" checked> Atualizar sinal automaticamente</label>
      </div>
    </aside>
  </main>

  <script>
    // -------- estado e util --------
    let type = 'candlestick';     // 'line' ou 'candlestick'
    let ohlc = [];                // dados do backend
    let closes = [];              // array de fechamentos
    let chartMain, chartRSI, chartMACD;
    let saldo = 10000; let plDia = 0;

    const fmtBR = v => v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});

    document.getElementById('saldo').textContent = 'R$ ' + fmtBR(saldo);
    document.getElementById('pl-dia').textContent = 'R$ ' + fmtBR(plDia);

    // -------- indicadores (JS) --------
    function SMA(arr, p){
      if(arr.length < p) return [];
      let out=[], s=0;
      for(let i=0;i<p;i++) s += arr[i];
      out.push(s/p);
      for(let i=p;i<arr.length;i++){
        s += arr[i]-arr[i-p];
        out.push(s/p);
      }
      return out;
    }
    function EMA(arr, p){
      if(arr.length < p) return [];
      const k = 2/(p+1);
      let out=[], prev = arr.slice(0,p).reduce((a,b)=>a+b,0)/p;
      out.push(prev);
      for(let i=p;i<arr.length;i++){
        prev = arr[i]*k + prev*(1-k);
        out.push(prev);
      }
      return out;
    }
    function RSI(arr, p=14){
      if(arr.length < p+1) return [];
      let gains=[],losses=[];
      for(let i=1;i<=p;i++){
        const ch = arr[i]-arr[i-1];
        gains.push(Math.max(ch,0));
        losses.push(Math.max(-ch,0));
      }
      let ag = gains.reduce((a,b)=>a+b,0)/p;
      let al = losses.reduce((a,b)=>a+b,0)/p;
      let rsis=[];
      let rs = (al===0)? Infinity : ag/al;
      rsis.push(100 - (100/(1+rs)));
      for(let i=p+1;i<arr.length;i++){
        const ch = arr[i]-arr[i-1];
        const g = Math.max(ch,0), l = Math.max(-ch,0);
        ag = (ag*(p-1)+g)/p; al = (al*(p-1)+l)/p;
        rs = (al===0)? Infinity : ag/al;
        rsis.push(100 - (100/(1+rs)));
      }
      return rsis;
    }
    function MACD(arr, f=12,s=26,sg=9){
      if(arr.length < s+sg) return {macd:[], signal:[]};
      const ef = EMA(arr,f), es = EMA(arr,s);
      const off = es.length - ef.length;
      let ml=[];
      for(let i=0;i<ef.length-off;i++) ml.push(ef[i+off]-es[i]);
      const sig = EMA(ml,sg);
      if(sig.length>0) ml = ml.slice(-sig.length);
      return {macd:ml, signal:sig};
    }

    // -------- render de gr√°ficos --------
    function destroyAll(){
      if(chartMain){ chartMain.destroy(); chartMain=null; }
      if(chartRSI){ chartRSI.destroy(); chartRSI=null; }
      if(chartMACD){ chartMACD.destroy(); chartMACD=null; }
    }

    function renderAll(){
      destroyAll();
      Chart.getChart("chartMain")?.destroy();
  Chart.getChart("chartRSI")?.destroy();
  Chart.getChart("chartMACD")?.destroy();

  const ctx = document.getElementById('chartMain').getContext('2d');
  ...
      const ctx = document.getElementById('chartMain').getContext('2d');
      const ctxR = document.getElementById('chartRSI').getContext('2d');
      const ctxM = document.getElementById('chartMACD').getContext('2d');

      const labels = ohlc.map(d=>d.x);
      closes = ohlc.map(d=>d.c);
      const s20 = SMA(closes,20);
      const s50 = SMA(closes,50);
      const rsi = RSI(closes,14);
      const {macd, signal} = MACD(closes);

      // --- gr√°fico principal
      let datasetsMain = [];
      if(type==='candlestick'){
        datasetsMain.push({
          type:'candlestick',
          label:'Pre√ßo',
          data: ohlc,
          color:{
            up:'#00ff99', down:'#ff4d4d',
            borderUp:'#00ff99', borderDown:'#ff4d4d',
            wickUp:'#00ff99', wickDown:'#ff4d4d'
          }
        });
      }else{
        datasetsMain.push({
          type:'line', label:'Pre√ßo',
          data: closes, borderColor:'#58ffb0',
          pointRadius:0, tension:.25
        });
      }
      // SMA overlays
      if(document.getElementById('sma20Ck').checked){
        const pad = labels.length - s20.length;
        datasetsMain.push({
          type:'line', label:'SMA20', data: Array(pad).fill(null).concat(s20),
          borderColor:'#28d5ff', borderWidth:1.5, pointRadius:0, tension:.25
        });
      }
      if(document.getElementById('sma50Ck').checked){
        const pad = labels.length - s50.length;
        datasetsMain.push({
          type:'line', label:'SMA50', data: Array(pad).fill(null).concat(s50),
          borderColor:'#ffcf33', borderWidth:1.5, pointRadius:0, tension:.25
        });
      }

      chartMain = new Chart(ctx, {
        data:{ labels, datasets: datasetsMain },
        options:{
          plugins:{ legend:{labels:{color:'#cfe'}} },
          scales:{
            x:{ ticks:{color:'#9bb'}, grid:{color:'#1a222a'} },
            y:{ ticks:{color:'#9bb'}, grid:{color:'#1a222a'} }
          },
          parsing:false,
          responsive:true
        }
      });

      // --- RSI
      const padRSI = labels.length - rsi.length;
      chartRSI = new Chart(ctxR,{
        type:'line',
        data:{
          labels, 
          datasets:[{
            label:'RSI', data:Array(padRSI).fill(null).concat(rsi),
            borderColor:'#9ad0ff', pointRadius:0, tension:.25
          },
          {label:'70', data:Array(labels.length).fill(70), borderColor:'#ff7777', pointRadius:0, borderDash:[6,6]},
          {label:'30', data:Array(labels.length).fill(30), borderColor:'#77ff77', pointRadius:0, borderDash:[6,6]}
          ]
        },
        options:{ plugins:{legend:{labels:{color:'#cfe'}}}, scales:{x:{ticks:{color:'#899'}},y:{ticks:{color:'#899'}} } }
      });

      // --- MACD
      const padMACD = labels.length - signal.length;
      chartMACD = new Chart(ctxM,{
        data:{
          labels,
          datasets:[
            {type:'line', label:'MACD', data:Array(padMACD).fill(null).concat(macd), borderColor:'#42ffb3', pointRadius:0, tension:.2},
            {type:'line', label:'Sinal', data:Array(padMACD).fill(null).concat(signal), borderColor:'#ffb362', pointRadius:0, tension:.2}
          ]
        },
        options:{ plugins:{legend:{labels:{color:'#cfe'}}}, scales:{x:{ticks:{color:'#899'}},y:{ticks:{color:'#899'}}} }
      });

      // IA
      if(document.getElementById('autoIA').checked){
        pedirSinalIA();
      }
    }

    async function reloadData(){
      const r = await fetch(`/ohlc?n=200`);
      const j = await r.json();
      if(j.ok){
        ohlc = j.data;
        renderAll();
      }
    }

    function toggleType(){
      type = (type==='candlestick')?'line':'candlestick';
      renderAll();
    }

    // -------- IA (chama backend /ia) --------
    async function pedirSinalIA(){
      const closesLoc = ohlc.map(d=>d.c);
      const r = await fetch('/ia', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({closes: closesLoc})
      });
      const j = await r.json();
      if(j.ok){
        document.getElementById('last-signal').textContent = j.sinal;
        document.getElementById('last-conf').textContent = j.confianca + '%';
        document.getElementById('reasons').innerHTML = j.motivos.map(m=>'‚Ä¢ '+m).join('<br/>');
      }
    }

    // -------- demo: executar compra/venda --------
    function executar(side){
      // simula√ß√£o simples: resultado = varia√ß√£o do √∫ltimo candle
      if(!ohlc.length) return;
      const last = ohlc[ohlc.length-1];
      const p = last.c - last.o; // ‚Äúprofit‚Äù fake
      const valor = Math.max(1, Math.min(50, Math.round(Math.abs(p)*10)));
      plDia += (side==='buy' ? p : -p) * 100; // escala
      saldo += (side==='buy' ? p : -p) * 100;
      document.getElementById('saldo').textContent = 'R$ ' + fmtBR(saldo);
      document.getElementById('pl-dia').textContent = 'R$ ' + fmtBR(plDia);
    }

    // eventos
    document.getElementById('sma20Ck').addEventListener('change', renderAll);
    document.getElementById('sma50Ck').addEventListener('change', renderAll);

    // start
    reloadData();
  </script>
</body>
</html>
