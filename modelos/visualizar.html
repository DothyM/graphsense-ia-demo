<!DOCTYPE html>
<html lang="pt-br">
>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GraphSense IA ‚Ä¢ Plataforma</title>

  <!-- Chart.js e plugin de candles -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/build/index.umd.min.js"></script>

  <style>
    body {
      margin: 0;
      background: #0c0e12;
      color: #e6f1ee;
      font-family: "Inter", system-ui, sans-serif;
    }

    header {
      background: #111417;
      border-bottom: 1px solid #1e2428;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      color: #31d17b;
      font-size: 22px;
      margin: 0;
    }

    button {
      background: #1b2421;
      color: #baffdf;
      border: 1px solid #1f6a47;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 700;
    }

    button:hover {
      background: #1f2e26;
    }

    main {
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 20px;
    }

    .card {
      background: #13171c;
      border: 1px solid #1b2127;
      border-radius: 12px;
      padding: 16px;
    }

    .title {
      font-weight: 700;
      margin-bottom: 10px;
      color: #cfece0;
    }

    canvas {
      width: 100% !important;
      height: 400px !important;
      background: #0e1014;
      border-radius: 10px;
    }

    .muted {
      color: #9aa6a0;
      font-size: 14px;
    }

    @media (max-width: 1000px) {
      main {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>üöÄ GraphSense IA</h1>
    <div>
      <button onclick="toggleType()">Alternar Linha ‚Üî Candle</button>
      <button onclick="reloadData()">Atualizar</button>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="title">üìà Gr√°fico Principal</div>
      <canvas id="chartMain"></canvas>
    </section>

    <aside class="card">
      <div class="title">‚öôÔ∏è Op√ß√µes</div>
      <label class="muted"><input type="checkbox" id="sma20" checked> SMA 20</label><br>
      <label class="muted"><input type="checkbox" id="sma50" checked> SMA 50</label><br>
      <p class="muted">Clique em ‚ÄúAlternar‚Äù para mudar entre Candle e Linha.</p>
    </aside>

    <section class="card" style="grid-column: 1 / -1;">
      <div class="title">RSI (14)</div>
      <canvas id="chartRSI"></canvas>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <div class="title">MACD (12,26,9)</div>
      <canvas id="chartMACD"></canvas>
    </section>
  </main>

  <script>
    let chartMain, chartRSI, chartMACD;
    let modo = 'candle';

    function destroyCharts() {
      chartMain?.destroy();
      chartRSI?.destroy();
      chartMACD?.destroy();
      Chart.getChart("chartMain")?.destroy();
      Chart.getChart("chartRSI")?.destroy();
      Chart.getChart("chartMACD")?.destroy();
    }

    async function reloadData() {
      const resp = await fetch('/ohlc?n=160');
      const j = await resp.json();
      if (!j.ok) return;
      renderAll(j.data);
    }

    function toggleType() {
      modo = (modo === 'candle') ? 'line' : 'candle';
      reloadData();
    }

    // ---------- Indicadores ----------
    const SMA = (arr, p) => arr.map((_, i, a) =>
      i < p - 1 ? null : a.slice(i - p + 1, i + 1).reduce((x, y) => x + y, 0) / p
    );

    const EMA = (arr, p) => {
      const k = 2 / (p + 1);
      let ema = [arr[0]];
      for (let i = 1; i < arr.length; i++) {
        ema.push(arr[i] * k + ema[i - 1] * (1 - k));
      }
      return ema;
    };

    const RSI = (arr, p = 14) => {
      let rsi = [];
      for (let i = 0; i < arr.length; i++) {
        if (i < p) { rsi.push(null); continue; }
        let gains = 0, losses = 0;
        for (let j = i - p; j < i; j++) {
          const diff = arr[j + 1] - arr[j];
          if (diff > 0) gains += diff;
          else losses -= diff;
        }
        const rs = gains / (losses || 1);
        rsi.push(100 - 100 / (1 + rs));
      }
      return rsi;
    };

    const MACD = (arr, f = 12, s = 26, sig = 9) => {
      const fast = EMA(arr, f);
      const slow = EMA(arr, s);
      const macd = arr.map((_, i) => (fast[i] || 0) - (slow[i] || 0));
      const signal = EMA(macd, sig);
      return { macd, signal };
    };

    // ---------- Renderiza√ß√£o ----------
    function renderAll(dados) {
      destroyCharts();

      const labels = dados.map(d => d.x);
      const closes = dados.map(d => d.c);
      const sma20 = SMA(closes, 20);
      const sma50 = SMA(closes, 50);
      const rsi = RSI(closes, 14);
      const macdObj = MACD(closes, 12, 26, 9);

      // --- Principal
      const ctxMain = document.getElementById('chartMain').getContext('2d');
      const sma20Check = document.getElementById('sma20').checked;
      const sma50Check = document.getElementById('sma50').checked;

      const datasets = [];

      if (modo === 'candle') {
        datasets.push({
          label: 'Candle',
          data: dados.map(d => ({ x: d.x, o: d.o, h: d.h, l: d.l, c: d.c })),
          type: 'candlestick',
          color: {
            up: '#00E676',      // verde claro para alta
            down: '#FF1744',    // vermelho para baixa
            unchanged: '#CCCCCC'
          },
          borderColor: '#31d17b'
        });
      } else {
        datasets.push({
          label: 'Linha',
          data: closes,
          borderColor: '#31d17b',
          borderWidth: 2,
          fill: false,
          pointRadius: 0,
          tension: 0.25
        });
      }

      if (sma20Check) {
        datasets.push({
          label: 'SMA 20',
          data: sma20,
          borderColor: '#FFEB3B',
          borderWidth: 1.3,
          pointRadius: 0,
          tension: 0.2
        });
      }

      if (sma50Check) {
        datasets.push({
          label: 'SMA 50',
          data: sma50,
          borderColor: '#03A9F4',
          borderWidth: 1.3,
          pointRadius: 0,
          tension: 0.2
        });
      }

      chartMain = new Chart(ctxMain, {
        data: { labels, datasets },
        options: {
          plugins: { legend: { labels: { color: '#9ad0b3' } } },
          scales: {
            x: { ticks: { color: '#9aa6a0' }, grid: { color: '#1b1f24' } },
            y: { ticks: { color: '#9aa6a0' }, grid: { color: '#1b1f24' } }
          }
        }
      });

      // --- RSI
      const ctxRSI = document.getElementById('chartRSI').getContext('2d');
      chartRSI = new Chart(ctxRSI, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'RSI (14)',
            data: rsi,
            borderColor: '#FFEB3B',
            borderWidth: 1.5,
            pointRadius: 0
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#e7dfa5' } } },
          scales: {
            x: { ticks: { color: '#9aa6a0' } },
            y: { ticks: { color: '#9aa6a0' }, suggestedMin: 0, suggestedMax: 100 }
          }
        }
      });

      // --- MACD
      const ctxMACD = document.getElementById('chartMACD').getContext('2d');
      chartMACD = new Chart(ctxMACD, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'MACD', data: macdObj.macd, borderColor: '#00E5FF', borderWidth: 1.5, pointRadius: 0 },
            { label: 'Signal', data: macdObj.signal, borderColor: '#FF4081', borderWidth: 1.2, pointRadius: 0 }
          ]
        },
        options: {
          plugins: { legend: { labels: { color: '#bfe7db' } } },
          scales: {
            x: { ticks: { color: '#9aa6a0' } },
            y: { ticks: { color: '#9aa6a0' } }
          }
        }
      });
    }

    reloadData();
  </script>
</body>
</html>
