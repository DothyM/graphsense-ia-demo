<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>GraphSense IA â€¢ Plataforma</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Plugin financeiro (candlestick) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/build/index.umd.min.js"></script>

  <style>
    :root{
      --bg:#0f1216;
      --panel:#12171d;
      --bord:#0f2a1d;
      --accent:#31d17b;
      --accent-2:#00c78a;
      --text:#e6f1ee;
      --muted:#a6b1ad;
      --warn:#ffbf00;
      --bear:#ef5350;
      --bull:#26a69a;
      --blue:#03A9F4;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:400 16px/1.4 "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
    }

    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      padding:14px 18px;
      border-bottom:1px solid #13201a;
      background:linear-gradient(180deg,#0c1014, #0f1216);
      position:sticky; top:0; z-index:50;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px;
      color:var(--accent);
      font-size:22px;
    }
    .badge{ background:#0e1a14; border:1px solid #153a2a; color:var(--accent); padding:8px 10px; border-radius:10px; font-weight:700 }
    .chip{ background:#0e141b; border:1px solid #1a293a; color:#bde1ff; padding:8px 10px; border-radius:10px; font-weight:700 }

    .btn{
      background:#0d1712; color:var(--text);
      border:1px solid #193c2b; padding:10px 14px; border-radius:10px;
      font-weight:700; cursor:pointer;
      transition:.15s ease; box-shadow:0 0 0 0 rgba(0,0,0,.0);
    }
    .btn:hover{ transform:translateY(-1px); border-color:#236645 }
    .btn.accent{ background:#10291f; border-color:#1f6a47; color:#baffdf }
    .btn.warn{ background:#1e1a0a; border-color:#866b0e; color:#ffe598 }

    .wrap{
      padding:18px;
      display:grid;
      gap:18px;
      grid-template-columns: 1fr 360px;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--bord);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 0 0 1px rgba(49,209,123,.05), 0 10px 30px rgba(0,0,0,.25);
    }
    .title{
      margin:4px 0 12px 4px; color:#cfece0; font-weight:800; letter-spacing:.3px;
    }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:18px }
    canvas{ width:100% !important; height:420px !important; }

    .side{
      display:flex; flex-direction:column; gap:14px;
      position:sticky; top:74px; height:calc(100vh - 100px); overflow:auto; padding-bottom:10px;
    }
    label{ color:var(--muted); font-size:14px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }

    .switch{ display:flex; align-items:center; gap:8px; }
    .switch input{ width:18px; height:18px; cursor:pointer }
    .kpi{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .kpi .item{ background:#0d1418; border:1px solid #1a2a36; padding:8px 10px; border-radius:10px; }
    .muted{ color:var(--muted) }

    @media (max-width: 1100px){
      .wrap{ grid-template-columns:1fr }
      .side{ position:relative; top:auto; height:auto }
      canvas{ height:360px !important; }
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">ðŸš€ GraphSense IA â€¢ Plataforma</div>
    <div class="kpi">
      <div class="badge">Demo</div>
      <div class="badge">Saldo: R$ 10.000,00</div>
      <div class="chip">P/L: R$ 0,00</div>
    </div>

    <div style="margin-left:auto" class="row">
      <select id="selAtivo" class="chip">
        <option>EURUSD</option>
        <option>USDJPY</option>
        <option>BTCUSD</option>
      </select>
      <select id="selTempo" class="chip">
        <option value="1m">1m</option>
        <option value="5m">5m</option>
        <option value="15m">15m</option>
      </select>

      <button class="btn" id="btnAtualizar">Atualizar</button>
      <button class="btn accent" id="btnAlternar">Alternar: Linha â†” Candle</button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h3 class="title">GrÃ¡fico</h3>
      <canvas id="chartMain"></canvas>
    </div>

    <div class="side">
      <div class="card">
        <h3 class="title">PreferÃªncias</h3>
        <div class="switch"><input type="checkbox" id="cbSMA20" checked> <label for="cbSMA20">SMA 20</label></div>
        <div class="switch"><input type="checkbox" id="cbSMA50" checked> <label for="cbSMA50">SMA 50</label></div>
        <div style="height:8px"></div>
        <div class="switch"><input type="checkbox" id="cbAuto" checked> <label for="cbAuto">Atualizar sinal automaticamente</label></div>
        <p class="muted">Motivos do sinal aparecerÃ£o aqui quando plugarmos IA.</p>
      </div>

      <div class="card">
        <h3 class="title">Ajuda</h3>
        <p class="muted">â€¢ Clique em <b>Alternar</b> para mudar Linha â†” Candle.<br>
        â€¢ Ative/desative <b>SMA 20/50</b> para ver as mÃ©dias.<br>
        â€¢ <b>Atualizar</b> puxa uma nova simulaÃ§Ã£o do endpoint <code>/ohlc</code>.</p>
      </div>
    </div>

    <div class="grid2" style="grid-column:1 / -1">
      <div class="card">
        <h3 class="title">RSI (14)</h3>
        <canvas id="chartRSI"></canvas>
      </div>
      <div class="card">
        <h3 class="title">MACD (12,26,9)</h3>
        <canvas id="chartMACD"></canvas>
      </div>
    </div>
  </div>

  <script>
    // -----------------------
    // Estado global
    // -----------------------
    let chartMain = null, chartRSI = null, chartMACD = null;
    let modo = 'candle'; // 'linha' | 'candle'
    const elSMA20 = document.getElementById('cbSMA20');
    const elSMA50 = document.getElementById('cbSMA50');

    // BotÃµes
    document.getElementById('btnAlternar').onclick = () => {
      modo = (modo === 'candle') ? 'linha' : 'candle';
      renderAll();
    };
    document.getElementById('btnAtualizar').onclick = () => renderAll();

    // -----------------------
    // Utils de indicadores
    // -----------------------
    function SMA(values, period){
      const out = [];
      for(let i=0;i<values.length;i++){
        const start = Math.max(0,i-period+1);
        const slice = values.slice(start, i+1);
        const m = slice.reduce((a,b)=>a+b,0)/slice.length;
        out.push(+m.toFixed(4));
      }
      return out;
    }

    function EMA(values, period){
      const k = 2/(period+1);
      const ema = [];
      values.forEach((v,i)=>{
        if(i===0){ ema.push(v); }
        else { ema.push( (v - ema[i-1]) * k + ema[i-1] ); }
      });
      return ema.map(v => +v.toFixed(4));
    }

    function RSI(values, period=14){
      const rsi = [];
      let gains=0, losses=0;
      for(let i=1;i<values.length;i++){
        const ch = values[i]-values[i-1];
        const g = ch>0? ch : 0;
        const l = ch<0? -ch: 0;
        if(i<=period){ gains += g; losses += l; rsi.push(50); }
        else{
          gains = (gains*(period-1)+g)/period;
          losses = (losses*(period-1)+l)/period;
          const rs = losses===0 ? 100 : gains/losses;
          const val = 100 - (100/(1+rs));
          rsi.push(+val.toFixed(2));
        }
      }
      rsi.unshift(50);
      return rsi;
    }

    function MACD(values, fast=12, slow=26, signal=9){
      const emaFast = EMA(values, fast);
      const emaSlow = EMA(values, slow);
      const macd = values.map((_,i)=> +(emaFast[i]-emaSlow[i]).toFixed(4));
      const signalArr = EMA(macd, signal);
      const hist = macd.map((v,i)=> +(v - signalArr[i]).toFixed(4));
      return { macd, signal: signalArr, hist };
    }

    function destroyAll(){
      try{ chartMain?.destroy(); }catch(e){}
      try{ chartRSI?.destroy(); }catch(e){}
      try{ chartMACD?.destroy(); }catch(e){}
      // forÃ§a limpeza de qualquer cache interno
      Chart.getChart("chartMain")?.destroy();
      Chart.getChart("chartRSI")?.destroy();
      Chart.getChart("chartMACD")?.destroy();
    }

    // -----------------------
    // RenderizaÃ§Ã£o completa
    // -----------------------
    async function renderAll(){
      destroyAll(); // evita "Canvas is already in use"

      // Carrega dados
      const resp = await fetch('/ohlc?n=160');
      const j = await resp.json();
      const dados = j.data;
      const labels = dados.map(d=>d.x);
      const closes = dados.map(d=>d.c);

      // Indicadores
      const sma20 = SMA(closes, 20);
      const sma50 = SMA(closes, 50);
      const rsi = RSI(closes, 14);
      const macdObj = MACD(closes, 12,26,9);

      // --------- GrÃ¡fico principal
      const ctxMain = document.getElementById('chartMain').getContext('2d');

      if(modo === 'linha'){
        const datasets = [{
          label:'PreÃ§o',
          data: closes,
          borderColor:'#4CAF50',
          borderWidth:2,
          pointRadius:0,
          tension:0.2
        }];

        if(elSMA20.checked){
          datasets.push({
            label:'SMA 20', data:sma20, borderColor:'#FFEB3B',
            borderWidth:1.5, pointRadius:0, tension:0.2
          });
        }
        if(elSMA50.checked){
          datasets.push({
            label:'SMA 50', data:sma50, borderColor:'#03A9F4',
            borderWidth:1.5, pointRadius:0, tension:0.2
          });
        }

        chartMain = new Chart(ctxMain, {
          type:'line',
          data:{ labels, datasets },
          options:{
            plugins:{ legend:{ labels:{ color:'#9ad0b3' } } },
            scales:{
              x:{ ticks:{ color:'#9aa6a0' } },
              y:{ ticks:{ color:'#9aa6a0' } }
            }
          }
        });

      } else {
        // Candle
        const candles = dados.map(d=>({x:d.x, o:d.o, h:d.h, l:d.l, c:d.c}));

        const datasets = [{
          label:'PreÃ§o',
          data:candles,
          type:'candlestick',
          borderColor:'#4CAF50',
          color:{ up:'#26a69a', down:'#ef5350', unchanged:'#999' }
        }];

        if(elSMA20.checked){
          datasets.push({
            label:'SMA 20',
            data:sma20.map((v,i)=>({x:labels[i], y:v})),
            type:'line',
            borderColor:'#FFEB3B', borderWidth:1.2, pointRadius:0, tension:0.2
          });
        }
        if(elSMA50.checked){
          datasets.push({
            label:'SMA 50',
            data:sma50.map((v,i)=>({x:labels[i], y:v})),
            type:'line',
            borderColor:'#03A9F4', borderWidth:1.2, pointRadius:0, tension:0.2
          });
        }

        chartMain = new Chart(ctxMain, {
          data:{ datasets },
          options:{
            plugins:{ legend:{ labels:{ color:'#9ad0b3' } } },
            scales:{
              x:{ ticks:{ color:'#9aa6a0' } },
              y:{ ticks:{ color:'#9aa6a0' } }
            }
          }
        });
      }

      // --------- RSI
      const ctxRSI = document.getElementById('chartRSI').getContext('2d');
      chartRSI = new Chart(ctxRSI, {
        type:'line',
        data:{
          labels, datasets:[{
            label:'RSI (14)',
            data:rsi, borderColor:'#FFEB3B',
            borderWidth:1.5, pointRadius:0
          }]
        },
        options:{
          plugins:{ legend:{ labels:{ color:'#e7dfa5' } } },
          scales:{
            x:{ ticks:{ color:'#9aa6a0' } },
            y:{ ticks:{ color:'#9aa6a0' }, suggestedMin:0, suggestedMax:100 }
          }
        }
      });

      // --------- MACD
      const ctxMACD = document.getElementById('chartMACD').getContext('2d');
      chartMACD = new Chart(ctxMACD, {
        type:'line',
        data:{
          labels,
          datasets:[
            { label:'MACD', data:macdObj.macd, borderColor:'#00c78a', borderWidth:1.6, pointRadius:0 },
            { label:'Signal', data:macdObj.signal, borderColor:'#ef5350', borderWidth:1.4, pointRadius:0 }
          ]
        },
        options:{
          plugins:{ legend:{ labels:{ color:'#bfe7db' } } },
          scales:{
            x:{ ticks:{ color:'#9aa6a0' } },
            y:{ ticks:{ color:'#9aa6a0' } }
          }
        }
      });
    }

    // Render inicial
    renderAll();
  </script>
</body>
</html>
